//@version=5
strategy("ETHUSDT_5bdb12c7", overlay=true, initial_capital=100, default_qty_type=strategy.percent_of_equity, default_qty_value=20)

// === INDICATORS ===
sma_1 = ta.sma(close, 154)
sma_2 = ta.sma(close, 135)
rsi_1 = ta.rsi(close, 7)
[macd_1, macd_1_sig, macd_1_hist] = ta.macd(close, 16, 40, 15)
[macd_2, macd_2_sig, macd_2_hist] = ta.macd(close, 6, 27, 10)
sma_3 = ta.sma(close, 127)

// === NaN HANDLING (match Python fallback values) ===
sma_1 := na(sma_1) ? 0.0 : sma_1
sma_2 := na(sma_2) ? 0.0 : sma_2
rsi_1 := na(rsi_1) ? 50.0 : rsi_1
macd_1 := na(macd_1) ? 0.0 : macd_1
macd_2 := na(macd_2) ? 0.0 : macd_2
sma_3 := na(sma_3) ? 0.0 : sma_3

// === SIGNAL CALCULATION ===
// Formula: score = sum((indicator_value - target) * weight / 100000)
score = 0.0
score := score + (sma_1 - 2556.472978) * -44457.22 / 100000.0
score := score + (sma_2 - 3180.292266) * -13968.07 / 100000.0
score := score + (rsi_1 - 20.381752) * -57325.81 / 100000.0
score := score + (close - 2753.131359) * -11640.81 / 100000.0
score := score + (macd_1 - -28.156218) * 71720.40 / 100000.0
score := score + (macd_2 - 29.345842) * -31931.29 / 100000.0
score := score + (close - 2423.612331) * -865.48 / 100000.0
score := score + (sma_3 - 2894.355593) * -59732.67 / 100000.0

// === STRATEGY LOGIC ===
longThreshold = 1.0
shortThreshold = -1.0
closeThreshold = 0.5
minBars = 200  // Warmup period for indicators

// Track position state
var int positionState = 0  // 0=none, 1=long, -1=short

// Skip first N bars (indicator warmup period)
if bar_index >= minBars
    // Open Long (only if no position)
    if score > longThreshold and positionState == 0
        strategy.entry("Long", strategy.long)
        positionState := 1

    // Open Short (only if no position)
    if score < shortThreshold and positionState == 0
        strategy.entry("Short", strategy.short)
        positionState := -1

    // Close Long (if in long and score drops)
    if score < -closeThreshold and positionState == 1
        strategy.close("Long")
        positionState := 0

    // Close Short (if in short and score rises)
    if score > closeThreshold and positionState == -1
        strategy.close("Short")
        positionState := 0

// === PLOTS ===
plot(score, color=score > 0 ? color.green : color.red, title="Score")
hline(longThreshold, "Long", color=color.green, linestyle=hline.style_dotted)
hline(shortThreshold, "Short", color=color.red, linestyle=hline.style_dotted)
bgcolor(bar_index < minBars ? color.new(color.gray, 90) : na, title="Warmup")