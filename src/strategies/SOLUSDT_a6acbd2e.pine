//@version=5
strategy("SOLUSDT GA Strategy", overlay=true, initial_capital=100, default_qty_type=strategy.percent_of_equity, default_qty_value=20)

// === INDICATORS ===
sma_1 = ta.sma(close, 74)
[macd_hist_1_m, macd_hist_1_s, macd_hist_1] = ta.macd(close, 10, 22, 11)
sma_2 = ta.sma(close, 88)
[macd_1, macd_1_sig, macd_1_hist] = ta.macd(close, 12, 39, 6)

// === NaN HANDLING (match Python fallback values) ===
sma_1 := na(sma_1) ? 0.0 : sma_1
macd_hist_1 := na(macd_hist_1) ? 0.0 : macd_hist_1
sma_2 := na(sma_2) ? 0.0 : sma_2
macd_1 := na(macd_1) ? 0.0 : macd_1

// === SIGNAL CALCULATION ===
// Formula: score = sum((indicator_value - target) * weight / 100000)
score = 0.0
score := score + (close - 113.349098) * -596855.64 / 100000.0
score := score + (close - 127.479292) * -395541.22 / 100000.0
score := score + (sma_1 - 120.314324) * 892025.30 / 100000.0
score := score + (macd_hist_1 - 120.810162) * 187346.41 / 100000.0
score := score + (sma_2 - 101.546350) * 381235.57 / 100000.0
score := score + (close - 134.258272) * -755868.62 / 100000.0
score := score + (macd_1 - 0.503069) * -779534.21 / 100000.0

// === STRATEGY LOGIC ===
longThreshold = 1.0
shortThreshold = -1.0
closeThreshold = 0.5
minBars = 200  // Warmup period for indicators

// Track position state
var int positionState = 0  // 0=none, 1=long, -1=short

// Skip first N bars (indicator warmup period)
if bar_index >= minBars
    // Open Long (only if no position)
    if score > longThreshold and positionState == 0
        strategy.entry("Long", strategy.long)
        positionState := 1

    // Open Short (only if no position)
    if score < shortThreshold and positionState == 0
        strategy.entry("Short", strategy.short)
        positionState := -1

    // Close Long (if in long and score drops)
    if score < -closeThreshold and positionState == 1
        strategy.close("Long")
        positionState := 0

    // Close Short (if in short and score rises)
    if score > closeThreshold and positionState == -1
        strategy.close("Short")
        positionState := 0

// === PLOTS ===
plot(score, color=score > 0 ? color.green : color.red, title="Score")
hline(longThreshold, "Long", color=color.green, linestyle=hline.style_dotted)
hline(shortThreshold, "Short", color=color.red, linestyle=hline.style_dotted)
bgcolor(bar_index < minBars ? color.new(color.gray, 90) : na, title="Warmup")